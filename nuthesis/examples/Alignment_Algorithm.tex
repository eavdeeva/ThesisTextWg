\section{Algorithm}
\label{sec:alignmentAlg}
%(mostly along the lines of my presentation for the USCMS workshop because it was time when I was the most active)

Why align?\\
How to align?\\
When align?\\
How to check that your alignment is good?\\

A tracking system detects hits produced by a charged particle traveling through the detector. In a presence of a constant magnetic field the particle has a helical trajectory. A reconstruction algorithm determines the track parameters by fitting the positions of hits assuming the helix trajectory.\\

Better hit resolution and the location uncertainty lead to better precision of a measurement of the track parameters. The location uncertainty depends on our knoledge of the positions and orienations in space of the tracking system modules. The hit resolution in the CMS pixel detector is~$\sim$15~$\mu$m. When the modules are mounted, their positions are known with precision of~$\sim$200~$\mu$m. Thus, we need to know positions of modules~20~times better than they are known when mounted.\\  

The procedure of the determination of the modules locations and orientations is called the tracker alignment. The concept of the track-based alignment can be illustrated in the example of the alignment of a toy tracker. When a charged particle passing through a detector (Fig.~\ref{fig:toyTracker_part1}, top left) it crosses a toy tracker which consists of six flat equidistant modules (Fig.~\ref{fig:toyTracker_part1}, top right). If the modules were placed exactly at their designed positions, we would observe the hits exactly at the points where the track crosses modules at the points of ideal geometry (Fig.~\ref{fig:toyTracker_part1}, middle left). However, in a reality the positions and tilts of the modules are different from ones suggested by the ideal geometry (Fig.~\ref{fig:toyTracker_part1}, middle right). Hits, indeed, are recorded at the places where modules are actually mounted, not at the design ideal places (Fig.~\ref{fig:toyTracker_part1}, bottom left). If we assumed a tracker to be ideal and a track to be smooth, we would see that our hits are off-track (Fig.~\ref{fig:toyTracker_part1}, bottom right). So, we recalculate positions of the modules so that all the hits are laying on the same smooth track (Fig.~\ref{fig:toyTracker_part2}, top left). But these recalculated positions still do not coincide with the actual positions (Fig.~\ref{fig:toyTracker_part2}, top right). Then we record more and more tracks (Fig.~\ref{fig:toyTracker_part2}, middle left and right). We take into account them all and determine the alignment parameters with necessary precision (Fig.~\ref{fig:toyTracker_part2}, bottom left and right).\\


\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker01.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker02.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker03.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker04.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker05.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker06.png}
    \end{center}
    \caption{The alignment of a toy tracker, part 1.}
    \label{fig:toyTracker_part1}
\end{figure}

\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker07.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker08.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker09.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker10.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker12.png}
        \includegraphics[width=0.45\textwidth]{../figs/Alignment/toyTracker13.png}
    \end{center}
    \caption{The alignment of a toy tracker, part 2.}
    \label{fig:toyTracker_part2}
\end{figure}


When we record a track with a not-aligned tracker, we see that the track is not smooth. But that is because our knowledge of module positions is not exact. Thus, we can correct the positions assuming the track is smooth. But when we process the next track, we may find out that the positions have to be corrected again. Thus, we record many tracks and minimize residuals between measured and predicted hits.\\

The CMS tracker contains 1440 silicon pixel modules in PXB and PXF and 15148 silicon strip modules in TIB, TOB, TID, TEC.\\

The tracker alignment problem is the least squared problem. The expression to minimize is the following:\\

\begin{equation}
%  \chi^2(\bf{p},\bf{q})=\sum_j^{tracks} \sum_i^{tracks} ({\frac{m_{ij}-f_{ij}(\bf{p},\bf{q_j})}{\sigma_{ij}}})^2
\end{equation}

%where $\bf{p}$ are parameters describing the tracker geometry, $\bf{q}_j$ are parameters of the $j^{th}$ track, $m_{ij}-f_{ij}$ are residuals, distances between the measured hit and a position predicted by the track fit, $\sigma_{ij}$ is the Gaussian error of the measurement.\\

We can align the large substructures and individual modules with respect to their substructures. The parameters to align large substructures include their positions and orientations of the subdetectors (rotations). Thus, each subsystem is described by six parameters: three coordinates X, Y, Z and three angles $\alpha$, $\beta$, $\gamma$. At the module level, we align positions and rotations with respect to the position s and angles of the corresponding large structure (Fig.~\ref{fig:alignmentParameters}). In addition, at the module level we align for surface deformations which are described by three parameters per sensor (Fig.~\ref{fig:surfaceDeformations}). \\

A track can be described with five parameters.\\
%We have two alignment algorithms: Millepede and HIP. Milledepe performs a simoultaneous fit of all alignment parametes and all track parameters while HIP perform iterative fits of alignment parameters $\bf{p}$ and track parameters $\bf{q}_j$.\\


It is important to use different sorts of tracks for the alignment. Cosmic tracks pass through the detector vertically and do not allow us to connect different subdetectors to one another. Collision tracks originate from the collision point and go in all directions. However, those tracks which cross TEC are all almost collinear and, therefore, it is difficult to measure $z$-coordinate of TEC modules with collision tracks only.\\

\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.70\textwidth]{../figs/Alignment/alignment_strip_coords.png}
    \end{center}
    \caption{Alignment parameters.}
    \label{fig:alignmentParameters}
\end{figure}

\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.90\textwidth]{../figs/Alignment/alignment_surface_deformations.png}
    \end{center}
    \caption{Surface deformations.}
    \label{fig:surfaceDeformations}
\end{figure}

\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.70\textwidth]{../figs/Alignment/track.png}
    \end{center}
    \caption{Track residuals.}
    \label{fig:trackAndResiduals}
\end{figure}

\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.70\textwidth]{../figs/Alignment/track.png}
    \end{center}
    \caption{Track residuals.}
    \label{fig:trackAndResiduals}
\end{figure}

\begin{figure}[htb]
    \begin{center}
        \includegraphics[width=0.70\textwidth]{../figs/Alignment/mpmatrix.pdf}
    \end{center}
    \caption{Track residuals.}
    \label{fig:trackAndResiduals}
\end{figure}
